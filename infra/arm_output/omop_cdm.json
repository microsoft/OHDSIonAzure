{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.17.1.54307",
      "templateHash": "13917290502647939939"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "The location for all resources."
      }
    },
    "postgresAtlasDatabaseName": {
      "type": "string",
      "metadata": {
        "description": "The name of webapi CDM database"
      }
    },
    "postgresServerName": {
      "type": "string",
      "metadata": {
        "description": "The name of the postgres server"
      }
    },
    "cdmContainerUrl": {
      "type": "string",
      "metadata": {
        "description": "The URL of the container where the CDM data is stored"
      }
    },
    "cdmSasToken": {
      "type": "securestring",
      "metadata": {
        "description": "The SAS token to access the CDM data"
      }
    },
    "postgresOMOPCDMDatabaseName": {
      "type": "string",
      "metadata": {
        "description": "The name of the OMOP CDM database"
      }
    },
    "postgresAdminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Admin password for the postgres server"
      }
    },
    "postgresWebapiAdminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Admin password for the webapi database"
      }
    },
    "postgresOMOPCDMPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Password for the cdm user"
      }
    },
    "keyVaultName": {
      "type": "string",
      "metadata": {
        "description": "The name of the keyvault"
      }
    }
  },
  "variables": {
    "$fxv#0": "CREATE ROLE ${POSTGRES_OMOP_CDM_ROLE} VALID UNTIL 'infinity';\r\nCOMMENT ON ROLE ${POSTGRES_OMOP_CDM_ROLE} IS 'Application group for OHDSI OMOP CDM'; \r\nCREATE ROLE ${POSTGRES_CDM_USERNAME} LOGIN ENCRYPTED PASSWORD ${CDM_MD5} VALID UNTIL 'infinity'; \r\nGRANT ${POSTGRES_OMOP_CDM_ROLE} TO ${POSTGRES_CDM_USERNAME};\r\nCOMMENT ON ROLE ${POSTGRES_CDM_USERNAME} IS 'Application user account for OHDSI OMOP CDM'; \r\nGRANT CONNECT, TEMPORARY ON DATABASE ${OMOP_CDM_DATABASE_NAME} TO GROUP ${POSTGRES_OMOP_CDM_ROLE};\r\n\r\nCREATE SCHEMA IF NOT EXISTS ${POSTGRES_OMOP_CDM_SCHEMA_NAME} AUTHORIZATION ${POSTGRES_ADMIN_USERNAME}; \r\n\r\nCOMMENT ON SCHEMA ${POSTGRES_OMOP_CDM_SCHEMA_NAME} IS 'Schema containing tables of the OMOP CDM'; \r\nGRANT USAGE ON SCHEMA ${POSTGRES_OMOP_CDM_SCHEMA_NAME} TO PUBLIC; \r\nGRANT USAGE ON SCHEMA ${POSTGRES_OMOP_CDM_SCHEMA_NAME} TO GROUP ${POSTGRES_OMOP_CDM_ROLE}; \r\nALTER DEFAULT PRIVILEGES IN SCHEMA ${POSTGRES_OMOP_CDM_SCHEMA_NAME} GRANT SELECT ON TABLES TO ${POSTGRES_OMOP_CDM_ROLE}; \r\nALTER DEFAULT PRIVILEGES IN SCHEMA ${POSTGRES_OMOP_CDM_SCHEMA_NAME} GRANT SELECT, USAGE ON SEQUENCES TO ${POSTGRES_OMOP_CDM_ROLE}; \r\nALTER DEFAULT PRIVILEGES IN SCHEMA ${POSTGRES_OMOP_CDM_SCHEMA_NAME} GRANT EXECUTE ON FUNCTIONS TO ${POSTGRES_OMOP_CDM_ROLE}; \r\nALTER DEFAULT PRIVILEGES IN SCHEMA ${POSTGRES_OMOP_CDM_SCHEMA_NAME} GRANT USAGE ON TYPES TO ${POSTGRES_OMOP_CDM_ROLE};\r\n\r\nCREATE SCHEMA IF NOT EXISTS ${POSTGRES_OMOP_RESULTS_SCHEMA_NAME} AUTHORIZATION ${POSTGRES_ADMIN_USERNAME}; \r\nCOMMENT ON SCHEMA ${POSTGRES_OMOP_RESULTS_SCHEMA_NAME} IS 'Schema containing tables of the OMOP Results'; \r\nGRANT USAGE ON SCHEMA ${POSTGRES_OMOP_RESULTS_SCHEMA_NAME} TO PUBLIC; \r\nGRANT USAGE ON SCHEMA ${POSTGRES_OMOP_RESULTS_SCHEMA_NAME} TO GROUP ${POSTGRES_OMOP_CDM_ROLE}; \r\nALTER DEFAULT PRIVILEGES IN SCHEMA ${POSTGRES_OMOP_RESULTS_SCHEMA_NAME} GRANT INSERT, SELECT, UPDATE, DELETE, REFERENCES, TRIGGER ON TABLES TO ${POSTGRES_OMOP_CDM_ROLE}; \r\nALTER DEFAULT PRIVILEGES IN SCHEMA ${POSTGRES_OMOP_RESULTS_SCHEMA_NAME} GRANT SELECT, USAGE ON SEQUENCES TO ${POSTGRES_OMOP_CDM_ROLE}; \r\nALTER DEFAULT PRIVILEGES IN SCHEMA ${POSTGRES_OMOP_RESULTS_SCHEMA_NAME} GRANT EXECUTE ON FUNCTIONS TO ${POSTGRES_OMOP_CDM_ROLE}; \r\nALTER DEFAULT PRIVILEGES IN SCHEMA ${POSTGRES_OMOP_RESULTS_SCHEMA_NAME} GRANT USAGE ON TYPES TO ${POSTGRES_OMOP_CDM_ROLE};\r\n\r\nCREATE SCHEMA IF NOT EXISTS ${POSTGRES_OMOP_TEMP_SCHEMA_NAME} AUTHORIZATION ${POSTGRES_ADMIN_USERNAME}; \r\nCOMMENT ON SCHEMA ${POSTGRES_OMOP_TEMP_SCHEMA_NAME} IS 'Schema containing tables of the OMOP Temporary'; \r\nGRANT USAGE ON SCHEMA ${POSTGRES_OMOP_TEMP_SCHEMA_NAME} TO PUBLIC; \r\nGRANT ALL ON SCHEMA ${POSTGRES_OMOP_TEMP_SCHEMA_NAME} TO GROUP ${POSTGRES_OMOP_CDM_ROLE}; \r\nALTER DEFAULT PRIVILEGES IN SCHEMA ${POSTGRES_OMOP_TEMP_SCHEMA_NAME} GRANT INSERT, SELECT, UPDATE, DELETE, REFERENCES, TRIGGER ON TABLES TO ${POSTGRES_OMOP_CDM_ROLE}; \r\nALTER DEFAULT PRIVILEGES IN SCHEMA ${POSTGRES_OMOP_TEMP_SCHEMA_NAME} GRANT SELECT, USAGE ON SEQUENCES TO ${POSTGRES_OMOP_CDM_ROLE}; \r\nALTER DEFAULT PRIVILEGES IN SCHEMA ${POSTGRES_OMOP_TEMP_SCHEMA_NAME} GRANT EXECUTE ON FUNCTIONS TO ${POSTGRES_OMOP_CDM_ROLE}; \r\nALTER DEFAULT PRIVILEGES IN SCHEMA ${POSTGRES_OMOP_TEMP_SCHEMA_NAME} GRANT USAGE ON TYPES TO ${POSTGRES_OMOP_CDM_ROLE};\r\n",
    "$fxv#1": "CREATE TABLE IF NOT EXISTS ${POSTGRES_OMOP_RESULTS_SCHEMA_NAME}.achilles_analysis\r\n(\r\n    analysis_id integer,\r\n    analysis_name character varying(255) COLLATE pg_catalog.\"default\",\r\n    stratum_1_name character varying(255) COLLATE pg_catalog.\"default\",\r\n    stratum_2_name character varying(255) COLLATE pg_catalog.\"default\",\r\n    stratum_3_name character varying(255) COLLATE pg_catalog.\"default\",\r\n    stratum_4_name character varying(255) COLLATE pg_catalog.\"default\",\r\n    stratum_5_name character varying(255) COLLATE pg_catalog.\"default\",\r\n    is_default integer,\r\n    category character varying(255) COLLATE pg_catalog.\"default\"\r\n)\r\nWITH (\r\n    OIDS = FALSE\r\n)\r\nTABLESPACE pg_default;\r\n\r\nALTER TABLE IF EXISTS ${POSTGRES_OMOP_RESULTS_SCHEMA_NAME}.achilles_analysis\r\n    OWNER to ${POSTGRES_ADMIN_USERNAME};\r\n\r\n\r\nCREATE TABLE IF NOT EXISTS ${POSTGRES_OMOP_RESULTS_SCHEMA_NAME}.achilles_results\r\n(\r\n    analysis_id integer,\r\n    stratum_1 character varying COLLATE pg_catalog.\"default\",\r\n    stratum_2 character varying COLLATE pg_catalog.\"default\",\r\n    stratum_3 character varying COLLATE pg_catalog.\"default\",\r\n    stratum_4 character varying COLLATE pg_catalog.\"default\",\r\n    stratum_5 character varying COLLATE pg_catalog.\"default\",\r\n    count_value bigint\r\n)\r\nWITH (\r\n    OIDS = FALSE\r\n)\r\nTABLESPACE pg_default;\r\n\r\nALTER TABLE IF EXISTS ${POSTGRES_OMOP_RESULTS_SCHEMA_NAME}.achilles_results\r\n    OWNER to ${POSTGRES_ADMIN_USERNAME};\r\n-- Index: idx_ar_aid\r\n\r\n-- DROP INDEX IF EXISTS ${POSTGRES_OMOP_RESULTS_SCHEMA_NAME}.idx_ar_aid;\r\n\r\nCREATE INDEX IF NOT EXISTS idx_ar_aid\r\n    ON ${POSTGRES_OMOP_RESULTS_SCHEMA_NAME}.achilles_results USING btree\r\n    (analysis_id ASC NULLS LAST)\r\n    TABLESPACE pg_default;\r\n-- Index: idx_ar_aid_s1\r\n\r\n-- DROP INDEX IF EXISTS ${POSTGRES_OMOP_RESULTS_SCHEMA_NAME}.idx_ar_aid_s1;\r\n\r\nCREATE INDEX IF NOT EXISTS idx_ar_aid_s1\r\n    ON ${POSTGRES_OMOP_RESULTS_SCHEMA_NAME}.achilles_results USING btree\r\n    (analysis_id ASC NULLS LAST, stratum_1 COLLATE pg_catalog.\"default\" ASC NULLS LAST)\r\n    TABLESPACE pg_default;\r\n-- Index: idx_ar_aid_s1234\r\n\r\n-- DROP INDEX IF EXISTS ${POSTGRES_OMOP_RESULTS_SCHEMA_NAME}.idx_ar_aid_s1234;\r\n\r\nCREATE INDEX IF NOT EXISTS idx_ar_aid_s1234\r\n    ON ${POSTGRES_OMOP_RESULTS_SCHEMA_NAME}.achilles_results USING btree\r\n    (analysis_id ASC NULLS LAST, stratum_1 COLLATE pg_catalog.\"default\" ASC NULLS LAST, stratum_2 COLLATE pg_catalog.\"default\" ASC NULLS LAST, stratum_3 COLLATE pg_catalog.\"default\" ASC NULLS LAST, stratum_4 COLLATE pg_catalog.\"default\" ASC NULLS LAST)\r\n    TABLESPACE pg_default;\r\n-- Index: idx_ar_s1\r\n\r\n-- DROP INDEX IF EXISTS ${POSTGRES_OMOP_RESULTS_SCHEMA_NAME}.idx_ar_s1;\r\n\r\nCREATE INDEX IF NOT EXISTS idx_ar_s1\r\n    ON ${POSTGRES_OMOP_RESULTS_SCHEMA_NAME}.achilles_results USING btree\r\n    (stratum_1 COLLATE pg_catalog.\"default\" ASC NULLS LAST)\r\n    TABLESPACE pg_default;\r\n-- Index: idx_ar_s2\r\n\r\n-- DROP INDEX IF EXISTS ${POSTGRES_OMOP_RESULTS_SCHEMA_NAME}.idx_ar_s2;\r\n\r\nCREATE INDEX IF NOT EXISTS idx_ar_s2\r\n    ON ${POSTGRES_OMOP_RESULTS_SCHEMA_NAME}.achilles_results USING btree\r\n    (stratum_2 COLLATE pg_catalog.\"default\" ASC NULLS LAST)\r\n    TABLESPACE pg_default;\r\n\r\n\r\n-- Table: ${POSTGRES_OMOP_RESULTS_SCHEMA_NAME}.achilles_results_dist\r\n\r\n-- DROP TABLE IF EXISTS ${POSTGRES_OMOP_RESULTS_SCHEMA_NAME}.achilles_results_dist;\r\n\r\nCREATE TABLE IF NOT EXISTS ${POSTGRES_OMOP_RESULTS_SCHEMA_NAME}.achilles_results_dist\r\n(\r\n    analysis_id integer,\r\n    stratum_1 character varying COLLATE pg_catalog.\"default\",\r\n    stratum_2 character varying COLLATE pg_catalog.\"default\",\r\n    stratum_3 character varying COLLATE pg_catalog.\"default\",\r\n    stratum_4 character varying COLLATE pg_catalog.\"default\",\r\n    stratum_5 character varying COLLATE pg_catalog.\"default\",\r\n    count_value bigint,\r\n    min_value numeric,\r\n    max_value numeric,\r\n    avg_value numeric,\r\n    stdev_value numeric,\r\n    median_value numeric,\r\n    p10_value numeric,\r\n    p25_value numeric,\r\n    p75_value numeric,\r\n    p90_value numeric\r\n)\r\nWITH (\r\n    OIDS = FALSE\r\n)\r\nTABLESPACE pg_default;\r\n\r\nALTER TABLE IF EXISTS ${POSTGRES_OMOP_RESULTS_SCHEMA_NAME}.achilles_results_dist\r\n    OWNER to ${POSTGRES_ADMIN_USERNAME};\r\n-- Index: idx_ard_aid\r\n\r\n-- DROP INDEX IF EXISTS ${POSTGRES_OMOP_RESULTS_SCHEMA_NAME}.idx_ard_aid;\r\n\r\nCREATE INDEX IF NOT EXISTS idx_ard_aid\r\n    ON ${POSTGRES_OMOP_RESULTS_SCHEMA_NAME}.achilles_results_dist USING btree\r\n    (analysis_id ASC NULLS LAST)\r\n    TABLESPACE pg_default;\r\n-- Index: idx_ard_s1\r\n\r\n-- DROP INDEX IF EXISTS ${POSTGRES_OMOP_RESULTS_SCHEMA_NAME}.idx_ard_s1;\r\n\r\nCREATE INDEX IF NOT EXISTS idx_ard_s1\r\n    ON ${POSTGRES_OMOP_RESULTS_SCHEMA_NAME}.achilles_results_dist USING btree\r\n    (stratum_1 COLLATE pg_catalog.\"default\" ASC NULLS LAST)\r\n    TABLESPACE pg_default;\r\n-- Index: idx_ard_s2\r\n\r\n-- DROP INDEX IF EXISTS ${POSTGRES_OMOP_RESULTS_SCHEMA_NAME}.idx_ard_s2;\r\n\r\nCREATE INDEX IF NOT EXISTS idx_ard_s2\r\n    ON ${POSTGRES_OMOP_RESULTS_SCHEMA_NAME}.achilles_results_dist USING btree\r\n    (stratum_2 COLLATE pg_catalog.\"default\" ASC NULLS LAST)\r\n    TABLESPACE pg_default;",
    "$fxv#2": "INSERT INTO ${WEBAPI_SCHEMA_NAME}.source (source_id, source_name, source_key, source_connection, source_dialect, is_cache_enabled) \r\nSELECT nextval('${WEBAPI_SCHEMA_NAME}.source_sequence'), '${OMOP_CDM_DATABASE_NAME}', '${OMOP_CDM_DATABASE_NAME}', '${OMOP_JDBC_CONNECTION_STRING}', 'postgresql', true;\r\n\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.source_daimon (source_daimon_id, source_id, daimon_type, table_qualifier, priority) \r\nSELECT nextval('${WEBAPI_SCHEMA_NAME}.source_daimon_sequence'), source_id, 0, '${POSTGRES_OMOP_CDM_SCHEMA_NAME}', 0\r\nFROM ${WEBAPI_SCHEMA_NAME}.source\r\nWHERE source_key = '${OMOP_CDM_DATABASE_NAME}';\r\n\r\n-- Vocabulary tables are in the same schema as the CDM tables\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.source_daimon (source_daimon_id, source_id, daimon_type, table_qualifier, priority) \r\nSELECT nextval('${WEBAPI_SCHEMA_NAME}.source_daimon_sequence'), source_id, 1, '${POSTGRES_OMOP_CDM_SCHEMA_NAME}', 1\r\nFROM ${WEBAPI_SCHEMA_NAME}.source\r\nWHERE source_key = '${OMOP_CDM_DATABASE_NAME}';\r\n\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.source_daimon (source_daimon_id, source_id, daimon_type, table_qualifier, priority) \r\nSELECT nextval('${WEBAPI_SCHEMA_NAME}.source_daimon_sequence'), source_id, 2, '${POSTGRES_OMOP_RESULTS_SCHEMA_NAME}', 1\r\nFROM ${WEBAPI_SCHEMA_NAME}.source\r\nWHERE source_key = '${OMOP_CDM_DATABASE_NAME}';\r\n\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.source_daimon (source_daimon_id, source_id, daimon_type, table_qualifier, priority) \r\nSELECT nextval('${WEBAPI_SCHEMA_NAME}.source_daimon_sequence'), source_id, 5, '${POSTGRES_OMOP_TEMP_SCHEMA_NAME}', 0\r\nFROM ${WEBAPI_SCHEMA_NAME}.source\r\nWHERE source_key = '${OMOP_CDM_DATABASE_NAME}';\r\n\r\n-- todo: add source user role\r\n\r\n-- Add permissions for the OMOP CDM source\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('cohortdefinition:*:generate:${OMOP_CDM_DATABASE_NAME}:get', 'Generate Cohort on Source with SourceKey = ${OMOP_CDM_DATABASE_NAME}');\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('cohortdefinition:*:report:${OMOP_CDM_DATABASE_NAME}:get',\t'Get Inclusion Rule Report for Source with SourceKey = ${OMOP_CDM_DATABASE_NAME}');\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('source:${OMOP_CDM_DATABASE_NAME}:access','Access to Source with SourceKey = ${OMOP_CDM_DATABASE_NAME}');\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('vocabulary:${OMOP_CDM_DATABASE_NAME}:*:get', '');\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('vocabulary:${OMOP_CDM_DATABASE_NAME}:included-concepts:count:post', '');\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('vocabulary:${OMOP_CDM_DATABASE_NAME}:resolveConceptSetExpression:post', '');\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('vocabulary:${OMOP_CDM_DATABASE_NAME}:lookup:identifiers:post', '');\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('vocabulary:${OMOP_CDM_DATABASE_NAME}:lookup:identifiers:ancestors:post', '');\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('vocabulary:${OMOP_CDM_DATABASE_NAME}:lookup:mapped:post', '');\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('vocabulary:${OMOP_CDM_DATABASE_NAME}:compare:post', '');\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('vocabulary:${OMOP_CDM_DATABASE_NAME}:optimize:post', '');\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('cdmresults:${OMOP_CDM_DATABASE_NAME}:*:get', '');\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('cdmresults:${OMOP_CDM_DATABASE_NAME}:*:*:get', '');\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('cdmresults:${OMOP_CDM_DATABASE_NAME}:conceptRecordCount:post', '');\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('cohortresults:${OMOP_CDM_DATABASE_NAME}:*:*:get', '');\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('cohortresults:${OMOP_CDM_DATABASE_NAME}:*:*:*:get', '');\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('vocabulary:${OMOP_CDM_DATABASE_NAME}:concept:*:get', '');\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('vocabulary:${OMOP_CDM_DATABASE_NAME}:concept:*:related:get', '');\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('cohortdefinition:*:cancel:${OMOP_CDM_DATABASE_NAME}:get', '');\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('vocabulary:${OMOP_CDM_DATABASE_NAME}:search:post', '');\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('ir:*:execute:${OMOP_CDM_DATABASE_NAME}:get', '');\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('ir:*:execute:${OMOP_CDM_DATABASE_NAME}:delete', '');\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('${OMOP_CDM_DATABASE_NAME}:person:*:get', '');\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('vocabulary:${OMOP_CDM_DATABASE_NAME}:lookup:sourcecodes:post', '');\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('cohort-characterization:*:generation:${OMOP_CDM_DATABASE_NAME}:post', '');\t\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('cohort-characterization:*:generation:${OMOP_CDM_DATABASE_NAME}:delete', '');\t\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('pathway-analysis:*:generation:${OMOP_CDM_DATABASE_NAME}:post', '');\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('pathway-analysis:*:generation:${OMOP_CDM_DATABASE_NAME}:delete', '');\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('ir:*:report:${OMOP_CDM_DATABASE_NAME}:get', '');\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('ir:*:info:${OMOP_CDM_DATABASE_NAME}:get', '');\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('vocabulary:${OMOP_CDM_DATABASE_NAME}:search:*:get', '');\t\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('cohortresults:${OMOP_CDM_DATABASE_NAME}:*:healthcareutilization:*:*:get',\t'Get cohort results baseline on period for Source with SourceKey = ${OMOP_CDM_DATABASE_NAME}');\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('cohortresults:${OMOP_CDM_DATABASE_NAME}:*:healthcareutilization:*:*:*:get', 'Get cohort results baseline on occurrence for Source with SourceKey = ${OMOP_CDM_DATABASE_NAME}');\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('ir:${OMOP_CDM_DATABASE_NAME}:info:*:delete', '');\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('vocabulary:${OMOP_CDM_DATABASE_NAME}:concept:*:ancestorAndDescendant:get', '');\r\nINSERT INTO ${WEBAPI_SCHEMA_NAME}.sec_permission (value, description)\r\n     VALUES ('vocabulary:${OMOP_CDM_DATABASE_NAME}:lookup:recommended:post', '');\r\n\r\n-- todo: assign permissions to source role",
    "$fxv#3": "#!/bin/bash\r\nset -o errexit\r\nset -o pipefail\r\nset -o nounset\r\n\r\nLOG_FILE=${AZ_SCRIPTS_PATH_OUTPUT_DIRECTORY}/all.log\r\n\r\nexec >  >(tee -ia ${LOG_FILE})\r\nexec 2> >(tee -ia ${LOG_FILE} >&2)\r\n\r\n# install postgresql client\r\necho 'installing psql...'\r\napk --update add postgresql-client gettext\r\n\r\n# create OMOP CDM schema and user\r\npg_cdm_password=\"${POSTGRES_OMOP_CDM_PASSWORD}${POSTGRES_CDM_USERNAME}\"\r\nexport CDM_MD5=\"'md5$(echo -n $pg_cdm_password | md5sum | awk '{ print $1 }')'\"\r\n\r\nprintf 'Creating omp cdm schemas and user\\n'\r\necho \"$SQL_create_omop_schemas\" | envsubst | psql \"$OMOP_CONNECTION_STRING\" -e\r\n\r\n# create OMOP CDM (+ Vocabulary) tables\r\nprintf 'Creating OMOP CDM tables\\n'\r\nsed -i  s/@cdmDatabaseSchema/${POSTGRES_OMOP_CDM_SCHEMA_NAME}/g OMOPCDM_postgresql_5.4_ddl.sql OMOPCDM_postgresql_5.4_constraints.sql OMOPCDM_postgresql_5.4_primary_keys.sql OMOPCDM_postgresql_5.4_indices.sql\r\npsql \"$OMOP_CONNECTION_STRING\" -e -f OMOPCDM_postgresql_5.4_ddl.sql -v ON_ERROR_STOP=1\r\n\r\n# create and load OMOP Results (Achilles) tables\r\nprintf 'Creating OMOP Results tables\\n'\r\necho \"$SQL_create_achilles_schema\" | envsubst | psql \"$OMOP_CONNECTION_STRING\" -e -v ON_ERROR_STOP=1\r\n\r\n# skip foreign key constraints for now due to open bug - https://github.com/OHDSI/CommonDataModel/issues/452\r\n# psql \"$OMOP_CONNECTION_STRING\" -f OMOPCDM_postgresql_5.4_constraints.sql\r\n\r\n# create OMOP CDM primary keys\r\nprintf 'Creating OMOP CDM primary keys\\n'\r\npsql \"$OMOP_CONNECTION_STRING\" -e -f OMOPCDM_postgresql_5.4_primary_keys.sql -v ON_ERROR_STOP=1\r\n\r\n# load OMOP CDM data\r\ntables=(\"cdm.concept_ancestor\" \"cdm.concept_relationship\" \"cdm.concept\" \"cdm.drug_strength\" \"cdm.concept_synonym\" \"cdm.measurement\" \"cdm.observation\" \"cdm.cost\" \"cdm.visit_detail\" \"cdm.visit_occurrence\" \"cdm.payer_plan_period\" \"cdm.drug_exposure\" \"cdm.procedure_occurrence\" \"cdm.condition_occurrence\" \"cdm.condition_era\" \"cdm.provider\" \"cdm.drug_era\" \"cdm.person\" \"cdm.relationship\" \"cdm.observation_period\" \"cdm.concept_class\" \"cdm.device_exposure\" \"cdm.death\" \"cdm.cdm_source\" \"cdm.vocabulary\" \"cdm.domain\" \"cdm_results.achilles_analysis\" \"cdm_results.achilles_results_dist\" \"cdm_results.achilles_results\")\r\nprintf 'Loading OMOP CDM data\\n'\r\nn=${#tables[@]}\r\ni=0\r\nfor element in \"${tables[@]}\"; do\r\n    ((i++)) || true\r\n    printf \"Downloading and extracting: %s (%s)\\n\" \"$element.csv.gz\" \"$i/$n\"\r\n    file=/tmp/\"$element\".csv\r\n    curl \"${OMOP_CDM_CONTAINER_URL}$element.csv.gz${OMOP_CDM_SAS_TOKEN}\" | gunzip > \"$file\"\r\n    num_of_records=$(wc -l \"$file\" | awk '{print $1}')\r\n    printf \"Copying %s records to table: %s\\n\" \"$num_of_records\" \"$element\"\r\n    psql \"$OMOP_CONNECTION_STRING\" -c \"\\COPY $element FROM '$file' WITH CSV;\" -v ON_ERROR_STOP=1\r\n    rm -f \"$file\"\r\n    printf \"done\\n\"\r\ndone\r\n\r\n# create OMOP CDM indices\r\nprintf 'creating OMOP CDM indices\\n'\r\npsql \"$OMOP_CONNECTION_STRING\" -e -f OMOPCDM_postgresql_5.4_indices.sql -v ON_ERROR_STOP=1\r\n\r\n# for now user will need to add a source via Atlas UI, there's work in progress to automate this\r\nprintf 'OMOP CDM created, you can now add it to Atlas as a source, connection string will avaiable in Azure KeyVault.\\n'\r\n\r\n# add OMOP CDM source to WebAPI\r\n# printf 'adding OMOP CDM source to WebAPI\\n'\r\n# echo \"$SQL_add_omop_source\" | envsubst | psql \"$ATLAS_DB_CONNECTION_STRING\" -e -v ON_ERROR_STOP=1\r\n",
    "postgresOMOPCDMSchemaName": "cdm",
    "postgresOMOPResultsSchemaName": "cdm_results",
    "postgresOMOPTempSchemaName": "temp",
    "postgresOMOPCDMRole": "cdm_reader",
    "postgresOMOPCDMUsername": "cdm_user",
    "postgresOMOPCDMUserSecretName": "[format('{0}-cdm-user-password', parameters('postgresOMOPCDMDatabaseName'))]",
    "postgresOMOPCDMJDBCConnectionStringSecretName": "[format('{0}-cdm-jdbc-connection-string', parameters('postgresOMOPCDMDatabaseName'))]",
    "postgresWebAPISchemaName": "webapi",
    "postgresWebapiAdminUsername": "ohdsi_admin_user",
    "postgresAdminUsername": "postgres_admin"
  },
  "resources": [
    {
      "type": "Microsoft.KeyVault/vaults/secrets",
      "apiVersion": "2022-07-01",
      "name": "[format('{0}/{1}', parameters('keyVaultName'), variables('postgresOMOPCDMUserSecretName'))]",
      "properties": {
        "value": "[parameters('postgresOMOPCDMPassword')]"
      }
    },
    {
      "type": "Microsoft.KeyVault/vaults/secrets",
      "apiVersion": "2022-07-01",
      "name": "[format('{0}/{1}', parameters('keyVaultName'), variables('postgresOMOPCDMJDBCConnectionStringSecretName'))]",
      "properties": {
        "value": "[format('jdbc:postgresql://{0}:5432/{1}?user={2}&password={3}&sslmode=require', reference(resourceId('Microsoft.DBforPostgreSQL/flexibleServers', parameters('postgresServerName')), '2022-12-01').fullyQualifiedDomainName, parameters('postgresOMOPCDMDatabaseName'), variables('postgresOMOPCDMUsername'), parameters('postgresOMOPCDMPassword'))]"
      }
    },
    {
      "type": "Microsoft.DBforPostgreSQL/flexibleServers/databases",
      "apiVersion": "2022-12-01",
      "name": "[format('{0}/{1}', parameters('postgresServerName'), parameters('postgresOMOPCDMDatabaseName'))]",
      "properties": {
        "charset": "utf8",
        "collation": "en_US.utf8"
      }
    },
    {
      "type": "Microsoft.Resources/deploymentScripts",
      "apiVersion": "2020-10-01",
      "name": "deployment-omop-cdm",
      "location": "[parameters('location')]",
      "kind": "AzureCLI",
      "properties": {
        "azCliVersion": "2.42.0",
        "timeout": "PT60M",
        "forceUpdateTag": "1",
        "environmentVariables": [
          {
            "name": "WEBAPI_SCHEMA_NAME",
            "value": "[variables('postgresWebAPISchemaName')]"
          },
          {
            "name": "ATLAS_DB_CONNECTION_STRING",
            "secureValue": "[format('host={0} port=5432 dbname={1} user={2} password={3} sslmode=require', reference(resourceId('Microsoft.DBforPostgreSQL/flexibleServers', parameters('postgresServerName')), '2022-12-01').fullyQualifiedDomainName, parameters('postgresAtlasDatabaseName'), variables('postgresWebapiAdminUsername'), parameters('postgresWebapiAdminPassword'))]"
          },
          {
            "name": "OMOP_CONNECTION_STRING",
            "secureValue": "[format('host={0} port=5432 dbname={1} user={2} password={3} sslmode=require', reference(resourceId('Microsoft.DBforPostgreSQL/flexibleServers', parameters('postgresServerName')), '2022-12-01').fullyQualifiedDomainName, parameters('postgresOMOPCDMDatabaseName'), variables('postgresAdminUsername'), parameters('postgresAdminPassword'))]"
          },
          {
            "name": "OMOP_JDBC_CONNECTION_STRING",
            "secureValue": "[format('jdbc:postgresql://{0}:5432/{1}?user={2}&password={3}&sslmode=require', reference(resourceId('Microsoft.DBforPostgreSQL/flexibleServers', parameters('postgresServerName')), '2022-12-01').fullyQualifiedDomainName, parameters('postgresOMOPCDMDatabaseName'), variables('postgresOMOPCDMUsername'), parameters('postgresOMOPCDMPassword'))]"
          },
          {
            "name": "OMOP_CDM_DATABASE_NAME",
            "value": "[parameters('postgresOMOPCDMDatabaseName')]"
          },
          {
            "name": "OMOP_CDM_CONTAINER_URL",
            "value": "[parameters('cdmContainerUrl')]"
          },
          {
            "name": "POSTGRES_ADMIN_USERNAME",
            "value": "[variables('postgresAdminUsername')]"
          },
          {
            "name": "POSTGRES_CDM_USERNAME",
            "value": "[variables('postgresOMOPCDMUsername')]"
          },
          {
            "name": "POSTGRES_OMOP_CDM_ROLE",
            "value": "[variables('postgresOMOPCDMRole')]"
          },
          {
            "name": "POSTGRES_OMOP_CDM_PASSWORD",
            "secureValue": "[parameters('postgresOMOPCDMPassword')]"
          },
          {
            "name": "OMOP_CDM_SAS_TOKEN",
            "value": "[parameters('cdmSasToken')]"
          },
          {
            "name": "POSTGRES_OMOP_CDM_SCHEMA_NAME",
            "value": "[variables('postgresOMOPCDMSchemaName')]"
          },
          {
            "name": "POSTGRES_OMOP_RESULTS_SCHEMA_NAME",
            "value": "[variables('postgresOMOPResultsSchemaName')]"
          },
          {
            "name": "POSTGRES_OMOP_TEMP_SCHEMA_NAME",
            "value": "[variables('postgresOMOPTempSchemaName')]"
          },
          {
            "name": "SQL_create_omop_schemas",
            "value": "[variables('$fxv#0')]"
          },
          {
            "name": "SQL_create_achilles_schema",
            "value": "[variables('$fxv#1')]"
          },
          {
            "name": "SQL_add_omop_source",
            "value": "[variables('$fxv#2')]"
          }
        ],
        "scriptContent": "[variables('$fxv#3')]",
        "supportingScriptUris": [
          "https://raw.githubusercontent.com/OHDSI/CommonDataModel/main/inst/ddl/5.4/postgresql/OMOPCDM_postgresql_5.4_ddl.sql",
          "https://raw.githubusercontent.com/OHDSI/CommonDataModel/main/inst/ddl/5.4/postgresql/OMOPCDM_postgresql_5.4_constraints.sql",
          "https://raw.githubusercontent.com/OHDSI/CommonDataModel/main/inst/ddl/5.4/postgresql/OMOPCDM_postgresql_5.4_primary_keys.sql",
          "https://raw.githubusercontent.com/OHDSI/CommonDataModel/main/inst/ddl/5.4/postgresql/OMOPCDM_postgresql_5.4_indices.sql"
        ],
        "cleanupPreference": "OnExpiration",
        "retentionInterval": "PT1H",
        "containerSettings": {
          "containerGroupName": "deployment-omop-cdm"
        }
      }
    }
  ]
}